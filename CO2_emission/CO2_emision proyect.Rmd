---
title: "CO2_emissions"
author: "Anabella"
date: "July 2023"
output: pdf_document
---
# CO2 emisions
With the dataset downloaded in
[Kaggle](https://www.kaggle.com/datasets/koustavghosh149/co2-emission-around-the-world)
I will make a basic analysis with R.

Import dataset
```{r}
df <- read.csv("~/2. Anabella/4.GITHUB/Proyects_with_R/CO2_emission/CO2_emission.csv")
str(df)

```
## DATA CLEANING  

### Removing null rows and repeated column

In the code below, CO2_emission[, 5:34] selects all columns from 1990 to 2019 (columns 5 to 34), and complete.cases(CO2_emission[, 5:34]) returns a logical vector indicating which rows have complete data in those columns. The subset operator [ is then used to select only those rows from the original data frame df.

```{r}
df <- df[complete.cases(df[,5:35]), ] 
df
```
Now I will Remove 2019b and Indicator.name columns

```{r}
df <- df[, -ncol(df)]
df

# delete the Indicator.name column
df <- subset(df, select= -Indicator.Name) 
```

df[, -ncol(df)] subsets the original data frame df by selecting all rows and all columns except the last column. The resulting data frame has the same number of rows as the original, but one less column.

### Rename column names

```{r}
colnames(df)[colnames(df) %in% c("Country.Name", "Region")] <- c("country_name", "region")

df
```

## DATA ANALYSIS  
```{r}
summary (df)

```

This is interestying. I can see that the mean CO2 emissions is arround 4 but the maximun emissions are arround 30 to 40 . I will plot this trend for a better understanding.

```{r}
df_data <- df[,4:ncol(df)]
mean_co2_per_year <- colMeans(df_data, na.rm = TRUE)
max_co2_per_column <- apply(df_data, 2, max, na.rm = TRUE)
min_co2_per_column <- apply(df_data, 2, min, na.rm = TRUE)



print(mean_co2_per_year)
print(max_co2_per_column)
print(min_co2_per_column)
```

## Plot of CO2 emissions over time

```{r}
# Load the required libraries
library(ggplot2)
library(gganimate)
library(transformr)

#Years vector
years = seq(1990, 2019)

# I have the vectors mean_co2_per_year,min and max_values_per_column
# Create a data.frame to store the data
df_plot <- data.frame(Year = years,
                      Mean_CO2_Emissions = mean_co2_per_year,
                      Max_CO2_Emissions = max_co2_per_column,
                      Min_CO2_Emissions = min_co2_per_column)

# Create a line plot 
p <- ggplot(df_plot, aes(x = Year)) +
  geom_line(aes(y = Mean_CO2_Emissions, color = "Mean CO2 Emissions"), size = 1.5) +
  geom_line(aes(y = Max_CO2_Emissions, color = "Max CO2 Emissions"), size = 1.5) +
  geom_line(aes(y = Min_CO2_Emissions, color = "Min CO2 Emissions"), size = 1.5) +
  labs(title = "CO2 Emissions Over Time",
       x = "Year",
       y = "CO2 Emissions",
       color = "Emission Type") +
  scale_color_manual(values = c("red4","darkorange", "deepskyblue4")) 

p

  
```
```{r}
ggsave("co2_overtime.png", plot = p, width = 10, height = 6, dpi = 600)

```

While the mean and minimun emissions have been stable over the years, the maximun emissions had a peak arround year 2000.
I will add a new column with the mean values of each country and test if there are significant differences among them with one way ANOVA test

```{r}
df$country_mean <- rowMeans(df[,5:ncol(df)], na.rm = TRUE)
df

```
```{r}
library(dplyr)
df_country_sorted <- df %>% arrange(desc(country_mean))

#Bar plot for the countries emissions 

# Here, we are using the "Dark2" color palette from RColorBrewer
library(RColorBrewer)

color_palette <- brewer.pal(n = 7, name = "Dark2") 


b <- ggplot(df_country_sorted, aes(x = reorder(country_code, +country_mean), y = country_mean, fill = region)) +
  geom_bar(stat = "identity") +  # Create the bar chart
  coord_flip() +  # Flip the x and y-axis to make a horizontal bar chart
labs(title = "Mean CO2 Emissions by Region",
     subtitle = "Each bar is one country",
       x = NULL, y = "Mean CO2 Emissions",
       fill = "World Region") +
  theme_minimal(base_size = 12) +
  theme (
  axis.text.x =NULL,
  axis.text.y = element_text(size = 1, hjust = 1),
  plot.background = element_rect(fill = "grey88", color = NA),
  panel.background = element_rect(fill = NA, color = NA)
  )+
  scale_fill_manual(values = color_palette)  # Set the defined color palette


b

ggsave("co2_country.png", plot = b, width = 10, height = 6, dpi = 600)



```
This plot shows that Middle East& North Africa has the countries with more CO2 emissions followed by North america ans Europe. Also, South asia and latin america are in the tail of the plot.  Lets support that with some statistic.


```{r}
top_five_country <- slice(df_country_sorted, 1:5)
```
 
 **ANOVA test**
I will do a ANOVA test in order to see the statistical significance of the differences in means between the regions   
* 2019 emissions
```{r}
df2019 <- subset(df[,c("country_name", "country_code", "region", "X2019")])
model2019 <- aov(X2019 ~ region, data = df2019)
summary(model2019)
```

* 1990 to 2019 emissions
```{r}
model <- aov(country_mean ~ region, data = df)
summary(model)
```

The results show that there is a significant difference between at least two of the Regions means.
To see with means are diferent I will make a LSD Fisher's test

**LSD Fisher's Test**  
*LSD (Least Significant Difference) Fisher test, also known as the Fisher's Least Significant Difference test, is a post-hoc test used after an ANOVA (Analysis of Variance) test to determine which pairs of group means are significantly different from each other. It compares the difference between two means to the average variability of all the means, as estimated from the ANOVA results.

The LSD test is useful when you have a significant ANOVA result with three or more groups, and you want to determine which specific groups are different from each other. It is a conservative test that adjusts for the multiple comparisons made between all possible pairs of group means. However, it assumes that the population variances are equal across all groups.

The LSD test works by calculating a critical value based on the alpha level (typically 0.05), the degrees of freedom within groups, and the error mean square from the ANOVA. Then, for each pair of means, it calculates the difference between them, and if the absolute value of this difference is greater than the critical value, it concludes that the means are significantly different.*

Load the library
```{r}
library(agricolae)
```

* 2019 emissions
```{r}
LSD_2019 <- LSD.test(model2019, "region", alpha = 0.05, console = TRUE)
```
North America, middle East and Europe are the regions with more Co2 emisions in 2019


* 1990 to 2019 emissions
```{r}
RegionLSD <- LSD.test(model, "region", alpha = 0.05, console = TRUE)

```
## DATA VIZ

Now that know the data, I will do a data viz over time with the top 5 countries and the top 3 regions. This code was adapted from 
title: "TidyTuesday 2020/27 - X-Men by Claremont Run Project"
author: "Cedric Scherer"
date: "30th of June 2020"
github link: https://github.com/z3tt/TidyTuesday/blob/main/R/2020_27_ClaremontRunXMen.Rmd

- First I will rearrage the dataset from wide to long format, creating separate rows for each year. 

```{r}
library(tidyr)

# Reshape the dataset using tidyr::pivot_longer
long_df <- df[, -ncol(df)] %>%
  pivot_longer(cols = -c(country_name, country_code, region),
               names_to = "year",
               values_to = "co2_emissions_metric_tons_per_capita")

# remove the "X" prefix from the year column and convert it to a numeric data type
long_df$year <- as.numeric(gsub("X", "", long_df$year))

```

```{r}
#check the structure of the df 
str(long_df)
unique_levels <- unique(df$region)
print(unique_levels)

```
### Data definition

```{r}
top_countries_codes <- c("QAT", "ARE", "BHR")
long_df_countries <- filter(long_df, country_code %in% top_countries_codes)

top_regions <- c("North America", "Middle East & North Africa", "Europe & Central Asia")
long_df_regions <- filter(long_df, region %in% top_regions)

```


```{r}
# Load packages
library(tidyverse)
library(fuzzyjoin)
library(ggstream)
library(colorspace)
library(ggtext)
library(cowplot)

```

```{r}
#setting ggplot theme

theme_set(theme_minimal(base_size = 12))

theme_update(
  plot.title = element_text(
    size = 15,
    face = "bold",
    hjust = .5,
    margin = margin(10, 5, 30, 5)
  ),
  plot.caption = element_text(
    size = 9,
    color = "grey40",
    hjust = .5,
    margin = margin(20, 0, 5, 0)
  ),
  axis.text.y = element_blank(),
  axis.title = element_blank(),
  plot.background = element_rect(fill = "grey88", color = NA),
  panel.background = element_rect(fill = NA, color = NA),
  panel.grid = element_blank(),
  panel.spacing.y = unit(0, "lines"),
  strip.text.y = element_blank(),
  legend.position = "bottom",
  legend.text = element_text(size = 9, color = "grey40"),
  legend.box.margin = margin(t = 30), 
  legend.background = element_rect(
    color = "grey40", 
    size = .3, 
    fill = "grey95"
  ),
  legend.key.height = unit(.25, "lines"),
  legend.key.width = unit(2.5, "lines"),
  plot.margin = margin(rep(20, 4))
)
```

```{r}
# Define the color palette
reds_palette <- colorRampPalette(colors = c("#FFCCCC", "#FF6666", "#FF0000"))

# Generate the palette with three shades of red
pal <- reds_palette(3)



```
trick to make the start and end of the stream smoother.

```{r}
df_smooth_country <- long_df_countries %>%
  group_by(country_name, country_code, region) %>%
  slice(1:4) %>%
  mutate(
    year = c(
      min(long_df_countries$year) - 5,
      min(long_df_countries$year) - 1,
      max(long_df_countries$year) + 1,
      max(long_df_countries$year) + 5
      ),
    co2_emissions_metric_tons_per_capita = c(0, 5, 5, 0),
  )

df_smooth_region <- long_df_regions %>%
  group_by(region) %>%
  slice(1:4) %>%
  mutate(
    year = c(
      min(long_df_regions$year) - 5,
      min(long_df_regions$year) - 1,
      max(long_df_regions$year) + 1,
      max(long_df_regions$year) + 5
      ),
    co2_emissions_metric_tons_per_capita = c(0, 5, 5, 0),
  )

#bind dataframes
long_df_countries_smooth <- long_df_countries %>% bind_rows(df_smooth_country)

long_df_regions_smooth  <- long_df_regions %>% bind_rows(df_smooth_region)


str(long_df_regions_smooth)

```
```{r}
grouped_long_df_regions_smooth <- long_df_regions_smooth %>%
  group_by(region, year) %>%
  summarize(avg_co2_emissions = mean(co2_emissions_metric_tons_per_capita), .groups = "drop")

str(grouped_long_df_regions_smooth)
```


Plot

```{r}
g_country <- long_df_countries_smooth %>% 
  ggplot(
    aes(
      year, co2_emissions_metric_tons_per_capita, 
      color = country_name, 
      fill = country_name
    )
  ) +
  geom_stream(
    geom = "contour",
    color = "white",
    size = 1.25,
    bw = .45 # Controls smoothness
  ) +
  geom_stream(
    geom = "polygon",
    bw = .45,
    size = 0
  ) +
  scale_color_manual(
    expand = c(0, 0),
    values = pal,
    guide = "none"
  ) +
  scale_fill_manual(
    values = pal,
    name = NULL
  ) 

g_region <- grouped_long_df_regions_smooth %>% 
  ggplot(
    aes(
      year, avg_co2_emissions, 
      color = region, 
      fill = region
    )
  ) +
  geom_stream(
    geom = "contour",
    color = "white",
    size = 1.25,
    bw = .45 # Controls smoothness
  ) +
  geom_stream(
    geom = "polygon",
    bw = .45,
    size = 0
  ) +
  scale_color_manual(
    expand = c(0, 0),
    values = pal,
    guide = "none"
  ) +
  scale_fill_manual(
    values = pal,
    name = NULL
  ) 
  
  

g_country
g_region

```


### Title and captions
```{r}
g_country <- g_country +
  labs(
    title = "Top 3 countries with more CO2 emissions in metrictons per capita",
    caption = "Visualization by Anabella Varela  •  Data obtained from Kaggle • "
  ) 

g_country

g_region <- g_region +
  labs(
    title = "Top 3 regions with more CO2 emissions in metrictons per capita",
    caption = "Visualization by Anabella Varela  •  Data obtained from Kaggle • "
  ) 
g_region
```

```{r}

ggsave("country_plot.png", plot = g_country, width = 10, height = 6, dpi = 600)
ggsave("region_plot.png", plot = g_region, width = 10, height = 6, dpi = 600)



```











